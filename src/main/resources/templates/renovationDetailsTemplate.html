<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="${record.getName()}">Renovation Details</title>
    <link th:href="@{/webjars/bootstrap/css/bootstrap.min.css}" rel="stylesheet"/>
    <link th:href="@{/css/styles.css}" rel="stylesheet">
    <link th:href="@{/css/body.css}" rel="stylesheet">
    <script th:src="@{/webjars/bootstrap/js/bootstrap.bundle.min.js}"></script>
    <link th:href="@{/css/button.css}" rel="stylesheet">
    <link rel="icon" type="image/x-icon" th:href="@{./favicon.ico}">
    <style>
        /* chatgpt told me how to do this*/
        .header-container {
            display: flex;
            align-items: center;
        }

        .button {
            background-color: #b4b4b4;
            border-radius: 5px;
            color: #272727;
            border: none;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin-left: 20px;
        }

        img {
            border: 5px solid #c7c7c7;
            border-radius: 5px;
            width: 100%;
            height: auto;
        }

        .row-rooms{
            align-items: stretch;
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            overflow-x: scroll;
            overflow-y: hidden;
        }

        .room-card {
            border-radius: 10px;
            max-width: 30%;
            padding: .75rem;
            margin-bottom: -1rem;
            border: 0;
            flex-basis: 100%;
            flex-grow: 0;
            flex-shrink: 0;
        }

        /* Circular and larger button */
        .icon-picker-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s, color 0.3s;
            border: none;
        }

        /* Remove Bootstrap's dropdown arrow */
        .icon-picker-btn::after {
            display: none !important;
        }

        /* Default grey plus when no icon is selected */
        .icon-picker-btn.no-icon {
            background: #f0f0f0;
            color: #888;
        }

        /* Darker grey plus on hover */
        .icon-picker-btn.no-icon:hover {
            background: #ddd;
            color: #555;
        }

        /* Styling for the remove (X) option */
        .icon-remove {
            font-size: 24px;
            padding: 10px;
            cursor: pointer;
            color: red;
        }

        .icon-remove:hover {
            color: darkred;
        }

        /* Dropdown visibility */
        .dropdown-menu-icons {
            display: none;
            position: absolute;
        }

        .dropdown-menu-icons.show {
            display: block;
        }

        /* Style all buttons in the dropdown */
        .icon-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem; /* Adjust padding to fit icons properly */
            min-width: 4rem; /* Ensure all buttons have a consistent width */
            height: 4rem; /* Make sure all buttons are the same height */
            border: none;
            font-size: 1.25rem;
            background-color: transparent; /* Optional: make background transparent */
        }

        .icon-btn i {
            font-size: 1.25rem; /* Make sure the icon size is consistent */
        }
        /* Dropdown visibility */
        .dropdown-menu-icons {
            display: none; /* Hidden by default */
            width: 80vw; /* Adjust width based on content */
            max-width: 550px; /* Optional: Set a max width if you want to limit the dropdown size */
            background-color: white; /* Add a background for visibility */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Optional: Add shadow for better appearance */
            border-radius: 8px; /* Optional: Rounded corners */
            z-index: 9999; /* Ensure it's above other content */
        }

        /* When the dropdown is visible, apply flexible horizontal grid layout */
        .dropdown-menu-icons.show {
            display: grid; /* Use grid for layout */
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); /* Flexible number of columns */
            gap: 10px; /* Space between items */
            justify-items: center; /* Center the icons horizontally */
        }

        /* Optional: Styling for the dropdown items */
        .dropdown-item-icons {
            padding: 10px;
            cursor: pointer;
            text-align: center;
        }

        button.badge {
            cursor: pointer;
            background-color: #e0e0e0;
            color: #333;
        }

        button.badge:hover {
            background-color: #d0d0d0;
        }

        button.badge i {
            font-size: 0.8em;
        }

        #suggestions {
            border: 1px solid #ccc;
            max-width: 250px;
            position: absolute;
            background: white;
            z-index: 1;
        }
        .suggestion {
            padding: 5px;
            cursor: pointer;
        }
        .suggestion:hover {
            background-color: #f0f0f0;
        }

        .notstarted {
            background-color: #6c757d;
            border-color: #6c757d;
            color: #fff;
            text-align: center;
        }

        .inprogress {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: #fff;
            text-align: center;
        }

        .completed {
            background-color: #198754;
            border-color: #198754;
            color: #ffffff;
            text-align: center;
        }

        .cancelled {
            background-color: #dc3545;
            border-color: #dc3545;
            color: #ffffff;
            text-align: center;
        }

        .blocked {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #000000;
            text-align: center;
        }
        .custom-btn {
            border: none !important;
            color: #ffffff;
            background-color: #34495E !important;
        }
        .custom-btn:hover {
            background-color: #3d566e !important;
            color: #ffffff !important;
        }
        .btn-check:checked + .custom-btn {
            background-color: #202d3a !important;
            color: #c5c5c5 !important;
        }
        .custom-btn:focus {
            outline: none !important;
            box-shadow: none !important;
            background-color: #3d566e !important;
        }
    </style>
</head>
<body>
    <div th:replace="~{fragments/header :: header}"></div>
    <div th:if="${tradies != null and !tradies.size() != 0}" th:replace="~{fragments/rateTradiesModal :: rateTradiesModal(${tradies}, true, ${completedJobId})}"></div>

    <div class="container rounded" style="min-height: 75vh">
        <div class="d-flex flex-wrap align-items-start" th:classappend="${searched == 'true'} ? 'mb-30px' : '' ">
            <div th:insert="~{fragments/breadCrumb :: bread-crumb-nav()}"></div>

            <a th:if="${searched == 'true'}"
               class="button btn-primary mt-3 ms-auto"
               style="margin-top: 0.5rem; color: white"
               th:href="@{/search(searchString=${search}, searchTags=${searchTags}, results-page=${searchPage})}">
                Back to search results
            </a>
        </div>
        <nav class="mt-3">
            <div class="nav nav-tabs" id="nav-tab" role="tablist">
                <a class="nav-link active" id="nav-details-tab" data-bs-toggle="tab" href="#nav-details" type="button" role="tab" aria-controls="nav-details" aria-selected="true">Details</a>
                <a class="nav-link" id="nav-jobs-tab" data-bs-toggle="tab" href="#nav-jobs" type="button" role="tab" aria-controls="nav-jobs" aria-selected="false">Jobs</a>
                <a th:if="${publicUser == false}" class="nav-link" id="nav-expenses-tab" data-bs-toggle="tab" href="#nav-expenses" type="button" role="tab" aria-controls="nav-expenses" aria-selected="false">Expenses</a>
                <a th:if="${publicUser == false}" class="nav-link" id="nav-calendar-tab" data-bs-toggle="tab" href="#nav-calendar" type="button" role="tab" aria-controls="nav-calendar" aria-selected="false">Calendar</a>
            </div>
        </nav>
        <div class="tab-content" id="nav-tabContent">
            <div class="tab-pane fade show active" id="nav-details" role="tabpanel" aria-labelledby="nav-details-tab">
                <div class="mt-xxl-3">
                    <div class="header-container d-flex flex-column flex-md-row">
                        <h1 class="text-break" th:text="${record.getName()}"></h1>

                        <div class="d-flex justify-content-center" th:if="${publicUser == false}">
                            <div class="fs-5 form-check">
                                <form th:action="@{/my-renovations/details/update-public-status(recordId=${recordId}, public=${!isPublic})}" method="post">
                                    <div class="btn-group" role="group" aria-label="Basic radio toggle button group">
                                        <input type="radio" class="btn-check" name="btnradio" id="btnradio1" autocomplete="off" th:checked="${!isPublic}" onchange="this.form.submit()">
                                        <label class="btn custom-btn" for="btnradio1">Private</label>

                                        <input type="radio" class="btn-check" name="btnradio" id="btnradio2" autocomplete="off" th:checked="${isPublic}" onchange="this.form.submit()">
                                        <label class="btn custom-btn" for="btnradio2">Public</label>
                                    </div>
                                </form>
                            </div>
                            <a th:href="@{/my-renovations/edit-renovation(recordId=${recordId},search=${searched} + '-'
                       + ${searchPage} + '-' + ${search} + '-' + ${searchTags})}" class="btn btn-secondary ms-4 w-auto">
                                <i class="bi bi-x-circle"></i>Edit &#10000
                            </a>
                        </div>
                    </div>
                </div>
                <div class="d-flex" th:if="${record.getStreetAddress() != null}">
                    <img th:src="@{'/icons/location-dot-solid-full.svg'}"
                         class="inline-icon"
                         alt="icon"/>
                    <h6 class="container mb-2 text-break" th:text="${record.getStreetAddress()} + ${record.getSuburb() != null ? ', ' + record.getSuburb()  : ''} +
                ${record.getCity()  != null ? ', ' + record.getCity() : ''} + ${record.getPostcode() != null ? ', '+ record.getPostcode() : ''} +
                ${record.getCountry() != null ? ', ' + record.getCountry() : ''}"></h6>
                </div>
                <div class="container mb-4 text-break" th:text="${renoDescription}"></div>
                <div class="header-container d-flex flex-content mb-3 mt-3">
                    <h3 class="me-4">Tags</h3>
                    <div th:if="${publicUser == false}">
                        <button class="btn btn-primary" th:if="${tags.size() < 5}" onclick="showAddTag()" id="showTagInput">+ Add tag</button>
                        <form id="tagNameForm" th:action="@{/my-renovations/details/add-tag(recordId=${recordId},job-page=${jobPage}, expensesPage=${expensePage},
                            search=${searched} + '-' + ${searchPage} + '-' + ${search} + '-' + ${searchTags})}" method="post">
                            <div class="input-group" id="hiddenTagCreator" hidden>
                                <input type="text" class="form-control z-0" placeholder="Enter Tag" id="tagName" autocomplete="off"
                                       th:name="newTag" th:value="${tagName}">
                                <button type="submit" class="btn btn-primary">Add</button>
                            </div>
                            <div id="suggestions" class="position-absolute text-break"></div>
                            <div id="tagErrorMessage" th:text="${tagErrorMessage}" class="invalid-feedback d-block"></div>
                        </form>
                    </div>
                </div>
                <div class="container mb-3">
                    <div th:if="${!tags.isEmpty()}" class="my-3">
                        <div class="d-flex flex-wrap gap-2">
                            <form th:each="tag : ${tags}"
                                  th:action="@{/my-renovations/details/remove-tag(recordId=${recordId}, tagNameRemove=${tag.getName()})}"
                                  method="post"
                                  class="d-inline badge rounded-pill bg-light text-dark fs-6 border-0">
                                <span th:text="${tag.getName()}">Tag</span>
                                <button th:if="${userIsOwner}"
                                        type="submit"
                                        class="bg-light text-dark fs-6 border-0"
                                        style="cursor: pointer; height: 60%">
                                    <span>x</span>
                                </button>
                            </form>
                        </div>
                    </div>
                    <div th:if="${tags.isEmpty()}">
                        <h5>No Tags</h5>
                    </div>
                </div>
                <h3>Rooms</h3>
                <div class="container mb-3 small-scroll-bar-list rounded" style="background-color: white; box-shadow: 0 0 0">
                    <div th:if="${!rooms.isEmpty()}" class="row-rooms" style="max-height: 25vh">
                        <div class="card room-card" th:each="room : ${rooms}" style="max-width: 350px; width: 75vw; max-height:90%;">
                            <div style="position:relative; height:85%">
                                <img th:src="@{${room.getImageFilename() != null ? '/profileImages/' + room.getImageFilename() :
                                '/images/RenovationRoomDefault.png'}}" loading="lazy" alt="Room Image" style="height:100%; max-width:100%">
                                <button style="left: 0;" type="submit"
                                        class="btn btn-secondary opacity-95 position-absolute sticky-top fs-6" data-bs-toggle="modal"
                                        th:data-bs-target="'#uploadImageModal'+${room.getId()}">
                                    &#10000
                                </button>
                            </div>
                            <h5 class="text-break" th:text="${room.getName()}"></h5>
                            <div class="modal fade" th:id="'uploadImageModal'+${room.getId()}" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="uploadImageLabel" th:text="'Upload Image for '+${room.getName()}"></h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <form th:id="'imageForm'+${room.getId()}" th:action="@{/add-room-image}"
                                                  method="post" enctype="multipart/form-data">
                                                <input type="hidden" th:name="recordId" th:value="${record.getId()}">
                                                <input type="hidden" th:name="roomId" th:value="${room.getId()}">
                                                <input type="file" name="file" th:roomId="${room.getId()}" onchange="submitImageForm(this)" class="form-control"
                                                       th:name="submittedFile" aria-label="file example" th:id="'roomImage' + ${room.getId()}" required>
                                                <div th:id="${'fileErrorMessage'+room.getId()}" th:text="${fileErrorMessage}" class="invalid-feedback"></div>
                                            </form>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div th:if="${rooms.isEmpty()}">
                        <h5>No Rooms</h5>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="nav-jobs" role="tabpanel" aria-labelledby="nav-jobs-tab">
                <div class="header-container d-flex flex-wrap flex-content mb-3 mt-3">
                    <h3 class="me-4">Jobs</h3>
                    <a th:href="@{/my-renovations/create-job(recordId=${recordId},search=${searched} + '-' + ${searchPage}
                    + '-' + ${search} + '-' + ${searchTags})}" class="btn btn-primary" th:if="${publicUser == false}">
                        + Add job
                    </a>
                    <div class="dropdown show ms-2">
                        <a class="btn btn-secondary dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false" th:text="${filter} == 'false' ? 'Filter' : ${filter}">
                        </a>

                        <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                            <form th:action="@{/my-renovations/details/filter-state(recordId=${recordId},job-page=${jobPage}, expensesPage=${expensePage}, search=${searched} + '-' + ${searchPage}
                + '-' + ${search} + '-' + ${searchTags}, filter = ${'false'})}" method="post">
                                <button class="dropdown-item"  >No Filter</button>
                            </form>
                            <form th:action="@{/my-renovations/details/filter-state(recordId=${recordId},job-page=${jobPage}, expensesPage=${expensePage}, search=${searched} + '-' + ${searchPage}
                + '-' + ${search} + '-' + ${searchTags}, filter = ${'Not Started'})}" method="post">
                                <button class="dropdown-item"  >Not Started</button>
                            </form>
                            <form th:action="@{/my-renovations/details/filter-state(recordId=${recordId},job-page=${jobPage}, expensesPage=${expensePage}, search=${searched} + '-' + ${searchPage}
                + '-' + ${search} + '-' + ${searchTags}, filter = ${'In Progress'})}" method="post">
                                <button class="dropdown-item"  >In Progress</button>
                            </form>
                            <form th:action="@{/my-renovations/details/filter-state(recordId=${recordId},job-page=${jobPage}, expensesPage=${expensePage}, search=${searched} + '-' + ${searchPage}
                + '-' + ${search} + '-' + ${searchTags}, filter = ${'Completed'})}" method="post">
                                <button class="dropdown-item"  >Completed</button>
                            </form>
                            <form th:action="@{/my-renovations/details/filter-state(recordId=${recordId},job-page=${jobPage}, expensesPage=${expensePage}, search=${searched} + '-' + ${searchPage}
                + '-' + ${search} + '-' + ${searchTags}, filter = ${'Cancelled'})}" method="post">
                                <button class="dropdown-item"  >Cancelled</button>
                            </form>
                            <form th:action="@{/my-renovations/details/filter-state(recordId=${recordId},job-page=${jobPage}, expensesPage=${expensePage}, search=${searched} + '-' + ${searchPage}
                + '-' + ${search} + '-' + ${searchTags}, filter = ${'Blocked'})}" method="post">
                                <button class="dropdown-item">Blocked</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div>
                    <ul style="overflow-y: auto;display: grid; grid-template-columns: repeat(auto-fill, minmax(550px, 1fr)); list-style-type: none; max-width: 100%; gap: 5px">
                        <div th:each="job : ${jobs}">
                            <li class="job-card card mb-4 shadow-sm border-0" style="width: 550px; max-width: 70vw">
                                <div class="card-body d-flex flex-column flex-md-row align-items-start">
                                    <form th:action="@{/my-renovations/update-icon(recordId=${recordId},jobId=${job.id},selectedIcon=${icon})}" method="post" class="mb-2 me-2">
                                        <a class="btn icon-picker-btn no-icon job-icon-btn" th:data-job-id="${job.getId()}" th:classappend="${publicUser} ? disabled ">
                                            <img class="job-icon"
                                                 th:src="@{'/icons/' + ${job.icon ?: 'plus-solid'} + '.svg'}" alt="icon"
                                                 th:data-job-id="${job.getId()}"
                                                 th:style="${job.getIcon() != null} ? 'width:40px; height:40px; border:none; outline:none;' : 'width:24px; height:24px; border:none; outline:none;'"/>
                                        </a> <div class="dropdown">
                                        <ul class="dropdown-menu-icons p-2 job-dropdown" th:data-job-id="${job.getId()}">
                                            <button type="submit" name="selectedIcon" th:value="${''}" class="dropdown-item-icons icon-btn">
                                                <img th:src="@{'/icons/xmark-solid.svg'}" class="icon-btn icon-remove m-2" alt="icon" th:data-job-id="${job.getId()}"/>
                                            </button>
                                            <button type="submit" name="selectedIcon" th:value="${icon}" class="dropdown-item-icons icon-btn" th:each="icon : ${icons}">
                                                <img th:src="@{'/icons/' + ${icon} + '.svg'}" class="job-icon icon-btn m-2" th:data-job-id="${job.getId()}"/>
                                            </button>
                                        </ul>
                                    </div>
                                    </form>
                                    <a th:href="@{/my-renovations/job-details(jobId=${job.getId()})}"
                                       class="flex-grow-1 text-decoration-none text-dark"
                                       style="transition: transform 0.1s;"
                                       onmouseover="this.style.transform='scale(1.01)'"
                                       onmouseout="this.style.transform='scale(1)'">
                                        <h5 class="text-break mb-1" th:text="${job.getName()}">Job Name</h5>
                                        <p class="text-break mb-2 small text-muted"
                                           th:text="${job.getDescription()}"
                                           style="width: 450px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                            Job Description
                                        </p>
                                        <dl class="row mb-0 small">
                                            <div class="col-12 col-md-6 mb-2">
                                                <dt>Status</dt>
                                                <dd th:text="${job.getStatus()}">Status</dd>
                                            </div>
                                            <div class="col-12 col-md-6 mb-2" th:if="${job.getType() != 'No Type'}">
                                                <dt>Type</dt>
                                                <dd th:text="${job.getType()}">Type</dd>
                                            </div>
                                            <div class="col-12 col-md-6 mb-2" th:if="${job.getStartDate() != null}">
                                                <dt>Start Date</dt>
                                                <dd th:text="${job.getStartDate()}">Start Date</dd>
                                            </div>
                                            <div class="col-12 col-md-6 mb-2" th:if="${job.getDueDate() != null}">
                                                <dt>Due Date</dt>
                                                <dd th:text="${job.getDueDate()}">Due Date</dd>
                                            </div>
                                        </dl>
                                    </a>
                                </div>
                                <div class="card-footer bg-white border-top pt-3" th:if="${publicUser == false}">
                                    <div class="d-flex flex-wrap gap-3 align-items-center justify-content-between">
                                        <a th:href="@{/my-renovations/edit-job(recordId=${recordId}, jobId=${job.getId()},search=${searched} + '-' + ${searchPage} + '-'+ ${search} + '-' + ${searchTags})}"
                                           class="btn btn-secondary" style="padding: 1px 3px">
                                            <i class="bi bi-x-circle"></i>Edit &#10000
                                        </a>
                                        <form th:action="@{/my-renovations/update-job-status(jobId=${job.getId()})}" method="post" class="d-inline">
                                            <select id="jobState" name="newJobStatus" class="form-select form-select-sm"
                                                    th:classappend="${job.getStatus().replaceAll(' ', '').toLowerCase()}"
                                                    onchange="submit()" style="width: 160px;">
                                                <option th:value="'Not Started'" th:selected="${job.getStatus().equals('Not Started')}">Not Started</option>
                                                <option th:value="'In Progress'" th:selected="${job.getStatus().equals('In Progress')}">In Progress</option>
                                                <option th:value="'Completed'" th:selected="${job.getStatus().equals('Completed')}">Completed</option>
                                                <option th:value="'Cancelled'" th:selected="${job.getStatus().equals('Cancelled')}">Cancelled</option>
                                                <option th:value="'Blocked'" th:selected="${job.getStatus().equals('Blocked')}">Blocked</option>
                                            </select>
                                        </form>
                                        <form th:action="@{/my-renovations/update-posted-status(jobId=${job.getId()},posted=${!job.getIsPosted()})}" method="post">
                                            <button th:if="${!job.getIsPosted()}" style="padding: 1px 3px" type="submit" class="btn btn-outline-primary">Post Job</button>
                                            <button th:if="${job.getIsPosted()}" style="padding: 1px 3px" type="submit" class="btn btn-primary">Retract Job</button>
                                        </form>
                                    </div>
                                </div>
                            </li>
                        </div>
                    </ul>
                </div>
                <div th:if="${jobs.isEmpty()}">
                    <h5>No Jobs</h5>
                </div>

                <!-- Pagination -->
                <div class="d-flex container justify-content-center">
                    <div class="d-block">
                        <div th:if="${jobPages.size() > 1}">
                            <div class="d-flex flex-column flex-md-row justify-content-center">
                                <ul class="pagination mb-1 d-flex justify-content-center">
                                    <!-- First -->
                                    <li class="page-item" th:classappend="${jobPage == 1} ? 'disabled'">
                                        <a class="page-link" th:href="@{/my-renovations/details(recordId=${recordId},job-page=${1}, expensesPage=${expensePage},
                                   search=${searched} + '-' + ${searchPage} + '-' + ${search} + '-' + ${searchTags}, filter=${filter})}">First</a>
                                    </li>
                                    <!-- Prev -->
                                    <li class="page-item" th:classappend="${jobPage == 1} ? 'disabled'">
                                        <a class="page-link" th:href="@{/my-renovations/details(recordId=${recordId},job-page=${jobPage -1}, expensesPage=${expensePage},
                                   search=${searched} + '-' + ${searchPage} + '-' + ${search} + '-' + ${searchTags}, filter=${filter})}">Prev</a>
                                    </li>
                                </ul>
                                <ul class="pagination mb-1 d-flex justify-content-center">
                                    <!-- pages: -2,-1,+0,+1,+2 -->
                                    <li class="page-item" th:each="page : ${jobPages}" th:if="${jobPage -2 == page ||jobPage -1 == page || jobPage == page || jobPage +1 == page || jobPage +2 == page}" th:classappend="${page == jobPage} ? ' active'">
                                        <a class="page-link" th:text="${page}" th:href="@{/my-renovations/details(recordId=${recordId},job-page=${page}, expensesPage=${expensePage},
                                   search=${searched} + '-' + ${searchPage} + '-' + ${search} + '-' + ${searchTags}, filter=${filter})}"></a>
                                    </li>
                                </ul>
                                <ul class="pagination d-flex justify-content-center">
                                    <!-- Next -->
                                    <li class="page-item" th:classappend="${jobPage == lastJobPage} ? 'disabled'">
                                        <a class="page-link" th:href="@{/my-renovations/details(recordId=${recordId},job-page=${jobPage +1}, expensesPage=${expensePage},
                                   search=${searched} + '-' + ${searchPage} + '-' + ${search} + '-' + ${searchTags}, filter=${filter})}">Next</a>
                                    </li>
                                    <!-- Last -->
                                    <li class="page-item" th:classappend="${jobPage == lastJobPage} ? 'disabled'">
                                        <a class="page-link" th:href="@{/my-renovations/details(recordId=${recordId},job-page=${lastJobPage}, expensesPage=${expensePage},
                                   search=${searched} + '-' + ${searchPage} + '-' + ${search} + '-' + ${searchTags}, filter=${filter})}">Last</a>
                                    </li>
                                </ul>
                            </div>
                            <!-- Enter page field and go button -->
                            <div th:if="${jobPages.size() > 1 && jobPages.get(jobPages.size() - 1) > 10}" class="ms-2 mb-3 d-flex justify-content-center">
                                <form th:action="@{/my-renovations/details(recordId=${recordId},job-page=${jobPage}, expensesPage=${expensePage},
                            search=${searched} + '-' + ${searchPage} + '-' + ${search} + '-' + ${searchTags}, filter=${filter})}" method="post">
                                    <div class="input-group">
                                        <input type="text" class="form-control w-25" placeholder="Enter page number" id="jobPageNumber"
                                               th:name="jobPageNumber" th:value="${jobPageNumber}">
                                        <input type="hidden" class="form-control w-25" placeholder="Enter page number" id="expensePageNumberHidden"
                                               th:name="expensePageNumber" th:value="${expensePage}">
                                        <button id="jobPageNumberBtn" class="btn btn-primary" type="submit">Go</button>
                                    </div>
                                    <div id="jobPageNumberErrorMessage" th:text="${jobPageNumberErrorMessage}" class="invalid-feedback d-block"></div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        <!--- expenses--->

        <div class="tab-pane fade" id="nav-expenses" role="tabpanel" aria-labelledby="nav-expenses-tab">
            <div class="container mb-3">
                <div class="header-container d-flex flex-content mb-3 mt-3">
                    <h3>Expense Breakdown</h3>
                </div>
                <div class="container mb-2 text-break" th:text="'Total Cost: $' + ${totalCost}"></div>
                <div class="container mb-2 text-break" th:text="'Number of Expenses: ' + ${totalExpenses}"></div>
                <div class="row row-cols-1 row-cols-md-3 g-4">
                    <div class="col" th:each="expense : ${expenses}">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title" th:text="${expense.getDescription()}"></h5>
                                <h6 class="card-subtitle mb-2" th:text="'$' + ${expense.getCost()}"></h6>
                                <p class="card-text">
                                    <strong>Category:</strong> <span th:text="${expense.getCategory()}"></span><br>
                                    <strong>Date:</strong> <span th:text="${expense.getDate()}"></span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="d-flex container justify-content-center">
                <div class="d-block">
                    <div th:if="${expensePages.size() > 1}">
                        <div class="d-flex flex-column flex-md-row justify-content-center">
                            <ul class="pagination mb-1 d-flex justify-content-center">
                                <!-- First -->
                                <li class="page-item" th:classappend="${expensePage == 1} ? 'disabled'">
                                    <a class="page-link" th:href="@{/my-renovations/details(recordId=${recordId},job-page=${jobPage}, expensesPage=${1},
                            search=${searched} + '-' + ${searchPage} + '-' + ${search} + '-' + ${searchTags}, filter=${filter})}">First</a>
                                </li>
                                <!-- Prev -->
                                <li class="page-item" th:classappend="${expensePage == 1} ? 'disabled'">
                                    <a class="page-link" th:href="@{/my-renovations/details(recordId=${recordId},job-page=${jobPage}, expensesPage=${expensePage - 1},
                            search=${searched} + '-' + ${searchPage} + '-' + ${search} + '-' + ${searchTags}, filter=${filter})}">Prev</a>
                                </li>
                            </ul>
                            <ul class="pagination mb-1 d-flex justify-content-center">
                                <!-- pages: -2,-1,+0,+1,+2 -->
                                <li class="page-item" th:each="page : ${expensePages}" th:if="${expensePage -2 == page ||expensePage -1 == page || expensePage == page || expensePage +1 == page || expensePage +2 == page}" th:classappend="${page == expensePage} ? ' active'">
                                    <a class="page-link" th:text="${page}" th:href="@{/my-renovations/details(recordId=${recordId},job-page=${jobPage}, expensesPage=${page},
                            search=${searched} + '-' + ${searchPage} + '-' + ${search} + '-' + ${searchTags}, filter=${filter})}"></a>
                                </li>
                            </ul>
                            <ul class="pagination d-flex justify-content-center">
                                <!-- Next -->
                                <li class="page-item" th:classappend="${expensePage == lastExpensePage} ? 'disabled'">
                                    <a class="page-link" th:href="@{/my-renovations/details(recordId=${recordId},job-page=${jobPage}, expensesPage=${expensePage + 1},
                            search=${searched} + '-' + ${searchPage} + '-' + ${search} + '-' + ${searchTags}, filter=${filter})}">Next</a>
                                </li>
                                <!-- Last -->
                                <li class="page-item" th:classappend="${expensePage == lastExpensePage} ? 'disabled'">
                                    <a class="page-link" th:href="@{/my-renovations/details(recordId=${recordId},job-page=${jobPage}, expensesPage=${lastExpensePage},
                            search=${searched} + '-' + ${searchPage} + '-' + ${search} + '-' + ${searchTags}, filter=${filter})}">Last</a>
                                </li>
                            </ul>
                        </div>
                        <!-- Enter page field and go button -->
                        <div th:if="${expensePages.size() > 1 && expensePages.get(expensePages.size() - 1) > 10}" class="ms-2 mb-3 d-flex justify-content-center">
                            <form th:action="@{/my-renovations/details(recordId=${recordId},job-page=${jobPage}, expensesPage=${expensePage},
                            search=${searched} + '-' + ${searchPage} + '-' + ${search} + '-' + ${searchTags}, filter=${filter})}" method="post">
                                <div class="input-group">
                                    <input type="text" class="form-control w-25" placeholder="Enter page number" id="expensePageNumber"
                                           th:name="expensePageNumber" th:value="${expensePageNumber}">
                                    <input type="hidden" class="form-control w-25" placeholder="Enter page number" id="jobPageNumberHidden"
                                           th:name="jobPageNumber" th:value="${jobPage}">
                                    <button id="expensePageNumberBtn" class="btn btn-primary" type="submit">Go</button>
                                </div>
                                <div id="expensePageNumberErrorMessage" th:text="${expensePageNumberErrorMessage}" class="invalid-feedback d-block"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="nav-calendar" role="tabpanel" aria-labelledby="nav-calendar-tab">
            <div th:replace="~{fragments/calendar :: calendar}"></div>
        </div>
    </div>
    </div>
<script th:src="@{/webjars/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script>
    window.onload = function() {
        setTimeout(function() {
            toggleNavbar();
        }, 1);

        if (document.getElementById("pageNumberErrorMessage") !== null &&
            document.getElementById("pageNumberErrorMessage").textContent !== "") {
            document.getElementById("pageNumber").classList.add("is-invalid");
        }
        if (document.getElementById("tagErrorMessage").textContent !== "" &&
            document.getElementById("tagName") !== null) {
            document.getElementById("tagName").classList.add("is-invalid");
        }
        if ("[[${showAddTagField}]]" === "true") {
            showAddTag()
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Saving current tab to local storage
        const tabLinks = document.querySelectorAll('a[data-bs-toggle="tab"]');
        tabLinks.forEach(tab => {
            tab.addEventListener('shown.bs.tab', function (e) {
                localStorage.setItem('activeTab', e.target.getAttribute('href'));
            });
        });

        const activeTab = localStorage.getItem('activeTab');
        if (activeTab) {
            const tabTrigger = document.querySelector(`a[href="${activeTab}"]`);
            if (tabTrigger) {
                new bootstrap.Tab(tabTrigger).show();
            }
        }

        // Job icon buttons
        const iconPickerBtns = document.querySelectorAll('.icon-picker-btn');
        iconPickerBtns.forEach(function (btn) {
            btn.addEventListener('click', function (event) {
                const jobId = event.target.getAttribute('data-job-id');
                const dropdown = document.querySelector(`.job-dropdown[data-job-id='${jobId}']`);
                if (dropdown && !dropdown.classList.contains('show')) {
                    document.querySelectorAll('.job-dropdown.show').forEach(function (dropdown) {
                        dropdown.classList.remove('show');
                    });
                    dropdown.classList.toggle('show');
                } else {
                    document.querySelectorAll('.job-dropdown.show').forEach(function (dropdown) {
                        dropdown.classList.remove('show');
                    });
                }
                event.preventDefault();
            });
        });


        document.addEventListener('click', function (event) {
            const isClickInside = event.target.closest('.dropdown, .icon-picker-btn');
            if (!isClickInside) {
                document.querySelectorAll('.job-dropdown.show').forEach(function (dropdown) {
                    dropdown.classList.remove('show');
                });
            }
        });
    });


    // Add tag button
    function showAddTag() {
        var x = document.getElementById("hiddenTagCreator");
        var y = document.getElementById("showTagInput")
        x.hidden = false;
        y.hidden = true;
    }


    // Page number input bar for jobs
    if (document.getElementById("jobPageNumberBtn") !== null) {
        document.getElementById("jobPageNumberBtn").addEventListener("click", function(event) {
            const jobPageNumber = document.getElementById("jobPageNumber").value.trim();
            let pages = "[[${jobPages}]]";
            pages = pages.slice(1, -1).split(", ").map(Number);
            if (jobPageNumber.length === 0 || isNaN(Number(jobPageNumber)) || jobPageNumber.includes(".")) {
                event.preventDefault();
                document.getElementById("jobPageNumberErrorMessage").textContent = "Please enter a whole number";
                document.getElementById("jobPageNumber").classList.add("is-invalid");
            } else if (!(pages[0] <= jobPageNumber) || !(jobPageNumber <= pages[pages.length - 1])) {
                event.preventDefault();
                document.getElementById("jobPageNumberErrorMessage").textContent =
                    "The page number is outside the range of available pages";
                document.getElementById("jobPageNumber").classList.add("is-invalid");
            }
        })
    }

    // Page number input bar for expenses
    if (document.getElementById("expensePageNumberBtn") !== null) {
        document.getElementById("expensePageNumberBtn").addEventListener("click", function(event) {
            const expensePageNumber = document.getElementById("expensePageNumber").value.trim();
            let pages = "[[${expensePages}]]";
            pages = pages.slice(1, -1).split(", ").map(Number);
            if (expensePageNumber.length === 0 || isNaN(Number(expensePageNumber)) || expensePageNumber.includes(".")) {
                event.preventDefault();
                document.getElementById("expensePageNumberErrorMessage").textContent = "Please enter a whole number";
                document.getElementById("expensePageNumber").classList.add("is-invalid");
            } else if (!(pages[0] <= expensePageNumber) || !(expensePageNumber <= pages[pages.length - 1])) {
                event.preventDefault();
                document.getElementById("expensePageNumberErrorMessage").textContent =
                    "The page number is outside the range of available pages";
                document.getElementById("expensePageNumber").classList.add("is-invalid");
            }
        })
    }

    // Tag name autocomplete suggestions
    const input = document.getElementById('tagName');
    const suggestionsBox = document.getElementById('suggestions');
    input.addEventListener('input', () => {
        const inputValue = input.value.toLowerCase().trim();
        suggestionsBox.innerHTML = '';


        if (inputValue.length > 0) {
            let suggestions = "[[${tagNames}]]";
            suggestions = suggestions.slice(1, -1)
            let suggestionList = [];
            if (suggestions !== "") {
                suggestionList = suggestions.split('`').map(suggestion => suggestion.trim());
            }
            let suggestionMatch = false;
            suggestionList.forEach(suggestion => {
                if (suggestion.startsWith(inputValue)) {
                    suggestionMatch = true;
                    const div = document.createElement('div');
                    div.className = 'suggestion';
                    div.textContent = suggestion;


                    div.addEventListener('click', () => {
                        input.value = suggestion;
                        document.getElementById("tagNameForm").submit();
                    });


                    suggestionsBox.appendChild(div);
                }
            });


            if (!suggestionMatch) {
                const div = document.createElement('div');
                div.className = 'suggestion text-muted';
                div.textContent = 'No matching tags';
                suggestionsBox.appendChild(div);
            }
        }
    });

    // Submitting room image form after image is selected
    function submitImageForm(item) {
        var roomId = item.getAttribute("roomId")

        document.getElementById('imageForm'+roomId).classList.remove("was-validated");
        const fi = document.getElementById('roomImage'+roomId);

        if (fi.files.length > 0) {
            for (let i = 0; i <= fi.files.length - 1; i++) {
                fsize = fi.files.item(i).size;
                const file = Math.round((fsize / 1024));
                if (file >= 10240) {
                    const errorDiv = document.getElementById('fileErrorMessage'+roomId);
                    errorDiv.textContent = "Image must be less than 10MB";
                    errorDiv.classList.add("d-block");
                } else {
                    document.getElementById('imageForm'+roomId).submit();
                }
            }
        }
    }

    // Reopening modal after invalid room image was submitted
    window.addEventListener("load", function () {
        const roomId = `[[${roomId}]]`;
        if (roomId) {
            if (document.getElementById("fileErrorMessage"+roomId).textContent !== "") {
                document.getElementById('imageForm'+roomId).classList.add("was-validated");
                const myModal = new bootstrap.Modal(document.getElementById('uploadImageModal'+roomId));
                myModal.show();
            }
        }
    });
</script>
</body>
<script th:if="${showCompletedModal}">
    document.addEventListener("DOMContentLoaded", function () {
        const rateTradiesModal = document.getElementById("rateTradiesModal");
        if (rateTradiesModal) {
            new bootstrap.Modal(rateTradiesModal).show();
        }
    })
</script>
</html>
