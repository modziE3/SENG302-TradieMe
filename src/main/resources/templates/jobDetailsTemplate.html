<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="${job.getName()}"></title>
    <link th:href="@{/webjars/bootstrap/css/bootstrap.min.css}" rel="stylesheet"/>
    <link th:href="@{/css/styles.css}" rel="stylesheet">
    <link th:href="@{/css/body.css}" rel="stylesheet">
    <link th:href="@{/css/button.css}" rel="stylesheet">
    <link rel="icon" type="image/x-icon" th:href="@{./favicon.ico}">
    <style>
        img {
            border: 5px solid #c7c7c7;
            border-radius: 5px;
            width: 100%;
            height: auto;
        }

        /* Circular and larger button */
        .icon-picker-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s, color 0.3s;
            border: none;
        }

        /* Remove Bootstrap's dropdown arrow */
        .icon-picker-btn::after {
            display: none !important;
        }

        /* Default grey plus when no icon is selected */
        .icon-picker-btn.no-icon {
            background: #f0f0f0;
            color: #888;
        }

        /* Darker grey plus on hover */
        .icon-picker-btn.no-icon:hover {
            background: #ddd;
            color: #555;
        }

        /* Styling for the remove (X) option */
        .icon-remove {
            font-size: 24px;
            padding: 10px;
            cursor: pointer;
            color: red;
        }

        .icon-remove:hover {
            color: darkred;
        }

        /* Dropdown visibility */
        .dropdown-menu-icons {
            display: none;
            position: absolute;
        }

        .dropdown-menu-icons.show {
            display: block;
        }

        /* Style all buttons in the dropdown */
        .icon-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem; /* Adjust padding to fit icons properly */
            min-width: 4rem; /* Ensure all buttons have a consistent width */
            height: 4rem; /* Make sure all buttons are the same height */
            border: none;
            font-size: 1.25rem;
            background-color: transparent; /* Optional: make background transparent */
        }

        .icon-btn i {
            font-size: 1.25rem; /* Make sure the icon size is consistent */
        }
        /* Dropdown visibility */
        .dropdown-menu-icons {
            display: none; /* Hidden by default */
            width: 80vw; /* Adjust width based on content */
            max-width: 550px; /* Optional: Set a max width if you want to limit the dropdown size */
            background-color: white; /* Add a background for visibility */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Optional: Add shadow for better appearance */
            border-radius: 8px; /* Optional: Rounded corners */
            z-index: 9999; /* Ensure it's above other content */
        }

        /* When the dropdown is visible, apply flexible horizontal grid layout */
        .dropdown-menu-icons.show {
            display: grid; /* Use grid for layout */
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); /* Flexible number of columns */
            gap: 10px; /* Space between items */
            justify-items: center; /* Center the icons horizontally */
        }

        /* Optional: Styling for the dropdown items */
        .dropdown-item-icons {
            padding: 10px;
            cursor: pointer;
            text-align: center;
        }

        .card-room {
            border-radius: 10px;
            max-width: 30%;
            padding: .75rem;
            margin-bottom: -1rem;
            border: 0;
            flex-basis: 33.333%;
            flex-grow: 0;
            flex-shrink: 0;
        }

        .row-rooms{
            align-items: stretch;
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            overflow-x: scroll;
            overflow-y: hidden;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>
<div th:if="${tradies != null}" th:replace="~{fragments/rateTradiesModal :: rateTradiesModal(${tradies}, false, ${jobId})}"></div>
<div class="container rounded" style="min-height: 87vh">

    <div class="d-flex flex-wrap align-items-start" style="margin-bottom: -10px">
        <div th:insert="~{fragments/breadCrumb :: bread-crumb-nav()}"></div>

        <a class="button btn-primary mt-3 ms-auto"
           style="margin-top: 0.5rem; translate: 0 -20px; color: white"
           href="#"
           id="back-button">
            Go Back
        </a>
    </div>
    <nav>
        <div class="nav nav-tabs" id="nav-tab" role="tablist">
            <a class="nav-link active" id="nav-details-tab" data-bs-toggle="tab" href="#nav-details" type="button" role="tab" aria-controls="nav-details" aria-selected="true">Details</a>
            <a th:if="${publicUser == false}" class="nav-link" id="nav-expenses-tab" data-bs-toggle="tab" href="#nav-expenses" type="button" role="tab" aria-controls="nav-expenses" aria-selected="false">Expenses</a>
            <a th:if="${publicUser == false}" class="nav-link" id="nav-quotes-tab" data-bs-toggle="tab" href="#nav-quotes" type="button" role="tab" aria-controls="nav-quotes" aria-selected="false">Quotes</a>
        </div>
    </nav>
    <div class="tab-content" id="nav-tabContent">
        <div class="tab-pane fade show active" id="nav-details" role="tabpanel" aria-labelledby="nav-details-tab">
            <div class="mt-xxl-3 mb-3">
                <div class="header-container d-flex flex-column flex-md-row">
                    <form th:action="@{/my-renovations/update-icon(recordId=${renovationRecord.getId()}, jobId=${job.getId()}, selectedIcon=${icon})}" method="post" >
                        <a class="btn icon-picker-btn no-icon job-icon-btn bg-white" th:data-job-id="${job.getId()}" th:classappend="${publicUser} ? disabled ">
                            <img class="job-icon"
                                 th:src="@{'/icons/' + ${job.getIcon() ?: 'plus-solid'} + '.svg'}"
                                 alt="icon"
                                 th:data-job-id="${job.getId()}"
                                 th:style="${job.getIcon() != null} ? 'width:40px; height:40px; border:none; outline:none;' : 'width:24px; height:24px; border:none; outline:none;'"/>
                        </a>
                        <div class="dropdown">
                            <ul class="dropdown-menu-icons p-2 job-dropdown" th:data-job-id="${job.getId()}">
                                <button type="submit" name="selectedIcon" th:value="${''}" class="dropdown-item-icons icon-btn">
                                    <img th:src="@{'/icons/xmark-solid.svg'}" class="icon-btn icon-remove m-2" alt="icon" th:data-job-id="${job.getId()}"/>
                                </button>
                                <button type="submit" name="selectedIcon" th:value="${icon}" class="dropdown-item-icons icon-btn" th:each="icon : ${icons}">
                                    <img th:src="@{'/icons/' + ${icon} + '.svg'}" class="job-icon icon-btn m-2" th:data-job-id="${job.getId()}"/>
                                </button>
                            </ul>
                        </div>
                    </form>

                    <h1 class="text-break ms-4 me-4" th:text="${job.getName()}"></h1>

                    <a th:if="${publicUser == true and quoted == false}"
                       th:href="@{/submit-quote(jobId=${job.getId()})}" class="btn btn-primary ms-2 mb-2 w-auto">
                        Submit Quote
                    </a>
                    <a th:if="${quoted == true}"
                       class="btn btn-dark ms-2 mb-2 w-auto">
                        Quote has been sent
                    </a>

                    <a th:if="${publicUser == false}"
                       th:href="@{/my-renovations/edit-job(recordId=${renovationRecord.getId()},jobId=${job.getId()},fromJob=true)}" class="btn btn-secondary ms-2 mb-2 w-auto">
                        <i class="bi bi-x-circle"></i>Edit &#10000
                    </a>

                    <form th:if="${publicUser == false}"
                          th:action="@{/my-renovations/update-job-status(jobId=${job.getId()})}" method="post"
                          class="ms-2 mb-2">
                        <select id="jobState" th:name="newJobStatus" class="form-select" th:classappend='${job.getStatus().replaceAll(" ", "").toLowerCase()}'
                                onchange="submit()" style="width: 150px;">
                            <option th:value="'Not Started'" th:selected="${job.getStatus().equals('Not Started')}">
                                Not Started
                            </option>
                            <option th:value="'In Progress'" th:selected="${job.getStatus().equals('In Progress')}">
                                In Progress
                            </option>
                            <option th:value="'Completed'" th:selected="${job.getStatus().equals('Completed')}">
                                Completed
                            </option>
                            <option th:value="'Cancelled'" th:selected="${job.getStatus().equals('Cancelled')}">
                                Cancelled
                            </option>
                            <option th:value="'Blocked'" th:selected="${job.getStatus().equals('Blocked')}">
                                Blocked
                            </option>
                        </select>
                    </form>

                    <form th:if="${publicUser == false}"
                          th:action="@{/my-renovations/update-posted-status(jobId=${job.getId()},posted=${!job.getIsPosted()})}"
                          method="post" class="ms-2 mb-2">
                        <button th:if="${!job.getIsPosted()}" type="submit" class="btn btn-outline-primary">Post Job</button>
                        <button th:if="${job.getIsPosted()}" type="submit" class="btn btn-primary">Retract Job</button>
                    </form>
                </div>
            </div>
            <div class="d-flex" th:if="${job.getRenovationRecord().getStreetAddress() != null}">
                <img th:src="@{'/icons/location-dot-solid-full.svg'}"
                     class="inline-icon"
                     alt="icon"/>
                <h6 class="container mb-2 text-break" th:text="${job.getRenovationRecord().getStreetAddress()} + ${job.getRenovationRecord().getSuburb() != null ? ', ' + job.getRenovationRecord().getSuburb()  : ''} +
                ${job.getRenovationRecord().getCity()  != null ? ', ' + job.getRenovationRecord().getCity() : ''} + ${job.getRenovationRecord().getPostcode() != null ? ', '+ job.getRenovationRecord().getPostcode() : ''} +
                ${job.getRenovationRecord().getCountry() != null ? ', ' + job.getRenovationRecord().getCountry() : ''}"></h6>
            </div>
            <div class="container mb-3">
                <p class="text-break" th:text="${job.getDescription()}"></p>
            </div>
            <div class="container mb-4">
                <dl class="row mb-0">
                    <div class="col-md-6">
                        <dt>Status</dt>
                        <dd th:text="${job.getStatus()}"></dd>
                    </div>
                    <div class="col-md-6" th:if="${job.getType() != 'No Type'}">
                        <dt>Type</dt>
                        <dd th:text="${job.getType()}"></dd>
                    </div>
                    <div class="col-md-6" th:if="${job.getStartDate() != null}">
                        <dt>Start Date</dt>
                        <dd th:text="${job.getStartDate()}"></dd>
                    </div>
                    <div class="col-md-6" th:if="${job.getDueDate() != null}">
                        <dt>Due Date</dt>
                        <dd th:text="${job.getDueDate()}"></dd>
                    </div>
                </dl>
            </div>
            <h3>Rooms</h3>
            <div class="container mb-3 small-scroll-bar-list rounded" style="background-color: white; box-shadow: 0 0 0">
                <div th:if="${!job.getRooms().isEmpty()}" class="row-rooms">
                    <div class="card-room" th:each="room : ${job.getRooms()}">
                        <div style="position:relative">
                            <img th:src="@{${room.getImageFilename() != null ? '/profileImages/' + room.getImageFilename() :
                                '/images/RenovationRoomDefault.png'}}" loading="lazy" alt="Room Image">
                            <button style="left: 0;" type="submit"
                                    class="btn btn-secondary opacity-95 position-absolute sticky-top fs-6" data-bs-toggle="modal"
                                    th:data-bs-target="'#uploadImageModal'+${room.getId()}">
                                &#10000
                            </button>
                        </div>
                        <h5 class="text-break" th:text="${room.getName()}"></h5>
                        <div class="modal fade" th:id="'uploadImageModal'+${room.getId()}" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="uploadImageLabel" th:text="'Upload Image for '+${room.getName()}"></h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form th:id="'imageForm'+${room.getId()}" th:action="@{/add-room-image}"
                                              method="post" enctype="multipart/form-data">
                                            <input type="hidden" th:name="recordId" th:value="${job.getRenovationRecord().getId()}">
                                            <input type="hidden" th:name="roomId" th:value="${room.getId()}">
                                            <input type="file" name="file" th:roomId="${room.getId()}" onchange="submitImageForm(this)" class="form-control"
                                                   th:name="submittedFile" aria-label="file example" th:id="'roomImage' + ${room.getId()}" required>
                                            <div th:id="${'fileErrorMessage'+room.getId()}" th:text="${fileErrorMessage}" class="invalid-feedback"></div>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div th:if="${job.getRooms().isEmpty()}">
                    <h5>No Rooms</h5>
                </div>
                </div>
            </div>
            <div class="tab-pane fade" id="nav-expenses" role="tabpanel" aria-labelledby="nav-expenses-tab">
                <div class="container mb-3">
                    <div class="header-container d-flex flex-content mb-3 mt-3">
                        <h3>Expense Breakdown</h3>
                        <a th:if="${publicUser == false}"
                           th:href="@{/my-renovations/add-expense(recordId=${renovationRecord.getId()},jobId=${job.getId()})}"
                           class="btn btn-primary ms-4">
                            Add Expense
                        </a>
                    </div>
                    <div class="container mb-2 text-break" th:text="'Total Cost: $' + ${totalCost}"></div>
                    <div class="container mb-2 text-break" th:text="'Number of Expenses: ' + ${totalExpenses}"></div>
                    <div class="row row-cols-1 row-cols-md-3 g-4">
                        <div class="col" th:each="expense : ${expenses}">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title" th:text="${expense.getDescription()}"></h5>
                                    <h6 class="card-subtitle mb-2" th:text="'$' + ${expense.getCost()}"></h6>
                                    <p class="card-text">
                                        <strong>Category:</strong> <span th:text="${expense.getCategory()}"></span><br>
                                        <strong>Date:</strong> <span th:text="${expense.getDate()}"></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-3" style="position: absolute; bottom: 0; left: 50%; transform: translate(-50%, 20%);" id="expensesPagination">
                    <div th:replace="~{fragments/pagination.html :: page-navigation(
                      @{/my-renovations/job-details(jobId=${job.getId()},quotesPage=${quotesPage},fromSearch=${fromSearch})},
                      ${expensesResults},
                      ${expensesPage},
                      ${lastPageExpenses},
                      'expensesPageNumber',
                      'expensesPage',
                      'expensesPageField',
                      'expensesGoButton',
                      'expensesPageFieldError')}">
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="nav-quotes" role="tabpanel" aria-labelledby="nav-quotes-tab">
                <a th:if="${receivedQuotes.?[status == 'Pending'].size() > 1}" class="btn btn-primary mt-3"
                   th:href="@{/my-renovations/job-details/compare-tradies(jobId=${job.getId()})}">Compare Tradies</a>
                <div class="row row-cols-1 row-cols-md-3 g-4 mt-2">
                    <h4 th:if="${receivedQuotes.size() == 0}">No received quotes.</h4>
                    <div class="col" th:each="quote : ${receivedQuotes}">
                        <div class="card h-100 shadow-sm">
                            <div tabindex="0" type="button" class="card-body d-flex justify-content-between align-items-center" data-bs-toggle="modal" th:data-bs-target="'#quoteDetails-' + ${quote.id}">
                                <div class="d-block">
                                    <h5 class="card-title" th:text="'For: ' + ${quote.getJob().getName()}"></h5>
                                    <h6 class="card-subtitle mb-2" th:text="'By ' + ${quote.getUser().getFirstName()} + ' ' + ${quote.getUser().getLastName()}"></h6>
                                    <h6 class="card-subtitle mb-2" th:text="'$'+${quote.getPrice()}+' for ' + ${quote.getWorkTime()}+'h'"></h6>
                                </div>
                                <div class="d-block">
                                    <div class="rounded-3 px-3 py-1" th:classappend='${quote.getStatus().toLowerCase()}' th:text="${quote.getStatus()}"></div>
                                </div>
                            </div>
                        </div>

                        <div class="modal fade" th:id="'quoteDetails-' + ${quote.id}" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" th:text="'$' + ${quote.getPrice()} + ' for ' + ${quote.getWorkTime()} + 'h'"></h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <h6 th:text="'For: ' + ${quote.getJob().getName()}"></h6>
                                        <h6 th:text="'By: ' + ${quote.getUser().getFirstName()} + ' ' + ${quote.getUser().getLastName()}"></h6>
                                        <a th:text="'Go to ' + ${quote.getUser().getFirstName()} + '\'s Profile'"
                                           th:href="@{/profile(userId=${quote.getUser().getId()})}">Go to Profile</a>
                                        <h6 th:text="${quote.getDescription()}"></h6>
                                        <h6 th:if="${quote.getEmail() != null}" th:text="'Email: ' + ${quote.getEmail()}"></h6>
                                        <h6 th:if="${quote.getPhoneNumber() != null}" th:text="'Phone number: ' + ${quote.getPhoneNumber()}"></h6>
                                    </div>
                                    <div class="modal-footer">
                                        <button th:if="${quote.getStatus().toLowerCase() != 'accepted' }" type="button" class="btn btn-success" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#confirmAccept" th:data-quote-id="${quote.getId()}">Accept</button>
                                        <button th:if="${quote.getStatus().toLowerCase() != 'rejected' }" type="submit" class="btn btn-danger" data-bs-dismis="modal" data-bs-toggle="modal" data-bs-target="#rejectQuoteModal" th:data-quote-id="${quote.getId()}">Reject</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-3" style="position: absolute; bottom: 0; left: 50%; transform: translate(-50%, 20%);" id="quotesPagination">
                    <div th:replace="~{fragments/pagination.html :: page-navigation(
                      @{/my-renovations/job-details(jobId=${job.getId()},expensesPage=${expensesPage},fromSearch=${fromSearch})},
                      ${quotesResults},
                      ${quotesPage},
                      ${lastPageQuotes},
                      'quotesPageNumber',
                      'quotesPage',
                      'quotesPageField',
                      'quotesGoButton',
                      'quotesPageFieldError')}">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--Modal for accepting quotes-->
    <div class="modal fade" id="confirmAccept" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    Are you sure you want to accept this quote?
                </div>
                <div class="modal-footer">
                    <form class="w-100" th:action="@{/my-renovations/job-details/accept-quote}" method="post">
                        <div class = "d-block">
                            <input class="form-check-input" type="checkbox" th:name="retract"  id="retractCheck">
                            <label class="form-check-label" for="retractCheck">
                                Do you wish to retract the job posting?
                            </label>
                        </div>
                        <div class = "d-block">
                            <input class="form-check-input" type="checkbox" th:name="transfer"  id="transferCheck">
                            <label class="form-check-label" for="transferCheck">
                                Do you wish to transfer this quote to an expense?
                            </label>
                        </div>
                        <div class="d-flex justify-content-end">
                            <input type="hidden" th:name="jobId" th:value="${jobId}">
                            <input type="hidden" th:name="fromSearch" th:value="${fromSearch}">
                            <input type="hidden" th:name="expensesPage" th:value="${expensesPage}">
                            <input type="hidden" th:name="quotesPage" th:value="${quotesPage}">
                            <input type="hidden" th:name="quoteId" id="confirmQuoteAccept">
                            <button type="button" class="btn btn-secondary me-2" id="cancelQuoteAccept" data-bs-target="#receivedQuoteDetails" data-bs-toggle="modal" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-success" data-bs-dismis="modal">Accept</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!--Modal for rejecting quotes-->
    <div class="modal fade" data-bs-keyboard="false" data-bs-backdrop="static" tabindex="-1" id="rejectQuoteModal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    Are you sure you want to reject this quote?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelQuoteReject" data-bs-target="#receivedQuoteDetails" data-bs-toggle="modal" data-bs-dismiss="modal">Cancel</button>
                    <form th:action="@{/my-renovations/job-details/reject-quote}" method="post">
                        <input type="hidden" th:name="quoteId" id="confirmQuoteReject">
                        <input type="hidden" th:name="jobId" th:value="${jobId}">
                        <input type="hidden" th:name="fromSearch" th:value="${fromSearch}">
                        <input type="hidden" th:name="expensesPage" th:value="${expensesPage}">
                        <input type="hidden" th:name="quotesPage" th:value="${quotesPage}">
                        <button type="submit" class="btn btn-danger" data-bs-dismis="modal">Reject</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script th:src="@{/webjars/bootstrap/js/bootstrap.bundle.min.js}"></script>
    <script>
        document.addEventListener("show.bs.modal", function (event) {
            let button = event.relatedTarget;
            let quoteId = button.getAttribute("data-quote-id");
            document.getElementById("confirmQuoteReject").value = quoteId;
            document.getElementById("cancelQuoteReject").setAttribute("data-bs-target", "#quoteDetails-"+quoteId);
        });
        document.getElementById('back-button').addEventListener('click', function (e) {
            e.preventDefault();

            const fromSearch = `[[${fromSearch}]]`;
            const fromWidget = `[[${fromWidget}]]`;
            const fromCalendar = `[[${fromCalendar}]]`;
            const recordId = `[[${renovationRecord.id}]]`;

            if (fromSearch === "true") {
                const backUrl = localStorage.getItem("jobListingPageUrl");
                if (backUrl) {
                    localStorage.removeItem("jobListingPageUrl");
                    window.location.href = backUrl;
                } else {
                    // Fallback if somehow nothing is stored
                    window.location.href = "../search"; // Change to your actual search URL
                }
            } else if (fromWidget === "true") {
                window.location.href = "../home";
            } else {
                let baseUrl = `../my-renovations/details?recordId=${recordId}`;
                if (fromCalendar === "true") {
                    localStorage.setItem("activeTab", "#nav-calendar")
                } else {
                    localStorage.setItem("activeTab", "#nav-jobs")
                }
                window.location.href = baseUrl;
            }
        });

        if (!localStorage.getItem("jobListingPageUrl")) {
            localStorage.setItem("jobListingPageUrl", document.referrer);
        }
        // Job icon buttons
        document.addEventListener('DOMContentLoaded', function () {
            const hash = window.location.hash;
            if (hash) {
                const trigger = document.querySelector(`a[href="${hash}"]`);
                if (trigger) {
                    new bootstrap.Tab(trigger).show();
                }
            }

            const iconPickerBtns = document.querySelectorAll('.icon-picker-btn');
            iconPickerBtns.forEach(function (btn) {
                btn.addEventListener('click', function (event) {
                    const jobId = event.target.getAttribute('data-job-id');
                    const dropdown = document.querySelector(`.job-dropdown[data-job-id='${jobId}']`);
                    if (dropdown && !dropdown.classList.contains('show')) {
                        document.querySelectorAll('.job-dropdown.show').forEach(function (dropdown) {
                            dropdown.classList.remove('show');
                        });
                        dropdown.classList.toggle('show');
                    } else {
                        document.querySelectorAll('.job-dropdown.show').forEach(function (dropdown) {
                            dropdown.classList.remove('show');
                        });
                    }
                    event.preventDefault();
                });
            });

            window.addEventListener('unload', function () {
                if ('[[${fromCalendar}]]') {
                    localStorage.setItem("lastViewedJobFromCalendar", '[[${jobId}]]');
                }
            });

            document.addEventListener('click', function (event) {
                const isClickInside = event.target.closest('.dropdown, .icon-picker-btn');
                if (!isClickInside) {
                    document.querySelectorAll('.job-dropdown.show').forEach(function (dropdown) {
                        dropdown.classList.remove('show');
                    });
                }
            });

            if (document.getElementById("pageNumberBtn") !== null) {
                document.getElementById("pageNumberBtn").addEventListener("click", function(event) {
                    const pageNumber = document.getElementById("pageNumber").value.trim();
                    let pages = "[[${pages}]]";
                    pages = pages.slice(1, -1).split(", ").map(Number);
                    if (pageNumber.length === 0 || isNaN(Number(pageNumber)) || pageNumber.includes(".")) {
                        event.preventDefault();
                        document.getElementById("pageNumberErrorMessage").textContent = "Please enter a whole number";
                        document.getElementById("pageNumber").classList.add("is-invalid");
                    } else if (!(pages[0] <= pageNumber) || !(pageNumber <= pages[pages.length - 1])) {
                        event.preventDefault();
                        document.getElementById("pageNumberErrorMessage").textContent =
                            "The page number is outside the range of available pages";
                        document.getElementById("pageNumber").classList.add("is-invalid");
                    }
                })
            }

            const tabLinks = document.querySelectorAll('a[data-bs-toggle="tab"]');
            tabLinks.forEach(tab => {
                tab.addEventListener('shown.bs.tab', function (e) {
                    localStorage.setItem('activeTab', e.target.getAttribute('href'));
                });
            });

            const activeTab = localStorage.getItem('activeTab');
            if (activeTab) {
                const tabTrigger = document.querySelector(`a[href="${activeTab}"]`);
                if (tabTrigger) {
                    new bootstrap.Tab(tabTrigger).show();
                }
            }
        });

        function positionPagination() {
            const lastPageExpenses = "[[${lastPageExpenses}]]"
            const lastPageQuotes = "[[${lastPageQuotes}]]"
            let offsetExpenses;
            let offsetQuotes;
            if (isTouchDevice()) {
                offsetExpenses = 0;
                offsetQuotes = 0;
                document.getElementById("expensesPagination").style.position = `relative`;
                document.getElementById("quotesPagination").style.position = `relative`;
            } else {
                offsetExpenses = lastPageExpenses >= 10 ? 10 : 200;
                offsetQuotes = lastPageQuotes >= 10 ? 10 : 200;
                document.getElementById("expensesPagination").style.position = `absolute`;
                document.getElementById("quotesPagination").style.position = `absolute`;
            }
            document.getElementById("expensesPagination").style.transform = `translate(-50%, -${offsetExpenses}%)`;
            document.getElementById("quotesPagination").style.transform = `translate(-50%, -${offsetQuotes}%)`;
        }

        function isTouchDevice() {
            return (('ontouchstart' in window) ||
                    (navigator.maxTouchPoints > 0) ||
                    (navigator.msMaxTouchPoints > 0)) ||
                window.innerWidth < 768 ||
                window.innerHeight < 768;
        }
        window.addEventListener('resize', function() {
            positionPagination();
        });
        window.addEventListener('load', function() {
            positionPagination();
        });

        document.addEventListener("DOMContentLoaded", function () {
            document.addEventListener("show.bs.modal", function (event) {
                let button = event.relatedTarget;
                let quoteId = button.getAttribute("data-quote-id");
                document.getElementById("confirmQuoteAccept").value = quoteId;
                document.getElementById("cancelQuoteAccept").setAttribute("data-bs-target", "#quoteDetails-"+quoteId);
            });
        });

        // Submitting room image form after image is selected
        function submitImageForm(item) {
            var roomId = item.getAttribute("roomId")

            document.getElementById('imageForm'+roomId).classList.remove("was-validated");
            const fi = document.getElementById('roomImage'+roomId);

            if (fi.files.length > 0) {
                for (let i = 0; i <= fi.files.length - 1; i++) {
                    fsize = fi.files.item(i).size;
                    const file = Math.round((fsize / 1024));
                    if (file >= 10240) {
                        const errorDiv = document.getElementById('fileErrorMessage'+roomId);
                        errorDiv.textContent = "Image must be less than 10MB";
                        errorDiv.classList.add("d-block");
                    } else {
                        document.getElementById('imageForm'+roomId).submit();
                    }
                }
            }
        }

        // Reopening modal after invalid room image was submitted
        window.addEventListener("load", function () {
            const roomId = `[[${roomId}]]`;
            if (roomId) {
                if (document.getElementById("fileErrorMessage"+roomId).textContent !== "") {
                    document.getElementById('imageForm'+roomId).classList.add("was-validated");
                    const myModal = new bootstrap.Modal(document.getElementById('uploadImageModal'+roomId));
                    myModal.show();
                }
            }
        });
    </script>
    <script th:if="${showCompletedModal}">
        document.addEventListener("DOMContentLoaded", function () {
            const rateTradiesModal = document.getElementById("rateTradiesModal");
            if (rateTradiesModal) {
                new bootstrap.Modal(rateTradiesModal).show();
            }
        })
    </script>
</body>
</html>